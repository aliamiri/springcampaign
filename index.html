<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>جشنواره بهاری</title>

    <link rel="stylesheet" href="style.css"/>

</head>
<body>
<div class="title">جشنواره بهاری ۱۴۰۳ بانکینو</div>
<div class="input-wrapper">
    <div class="input-wrapper-inside winner" id="winner">
        <div class="winner-phone">
            ۰۹۳۸****۵۶۹
        </div>
        <div class="winner-name">
            ناصرخان داورزنی اصل کَسکنی سفلی
        </div>
        <div class="winner-chance" dir="rtl">
            ۱۳۸۹ شانس
        </div>
    </div>

    <div class="input-wrapper-inside input" id="input">
        <div class="chance-number chance-number-input first-number" contenteditable="true"
             oninput="convertInputToPersianNumerals(this); jumpToNext(this)"></div>
        <div class="chance-number chance-number-input" contenteditable="true"
             oninput="convertInputToPersianNumerals(this); jumpToNext(this)"></div>
        <div class="chance-number chance-number-input" contenteditable="true"
             oninput="convertInputToPersianNumerals(this); jumpToNext(this)"></div>
        <div class="chance-number chance-number-input" contenteditable="true"
             oninput="convertInputToPersianNumerals(this); jumpToNext(this)"></div>
        <div class="chance-number chance-number-input" contenteditable="true"
             oninput="convertInputToPersianNumerals(this); jumpToNext(this)"></div>
        <div class="chance-number chance-number-input" contenteditable="true"
             oninput="convertInputToPersianNumerals(this); jumpToNext(this)"></div>
    </div>

    <div class="input-wrapper-inside spinner" id="spinner">
        <div class="chance-number door first-number">
            <div class="boxes">
            </div>
        </div>
        <div class="chance-number door middle-number">
            <div class="boxes">
            </div>
        </div>
        <div class="chance-number door middle-number">
            <div class="boxes">
            </div>
        </div>
        <div class="chance-number door middle-number">
            <div class="boxes">
            </div>
        </div>
        <div class="chance-number door middle-number">
            <div class="boxes">
            </div>
        </div>
        <div class="chance-number door last-number">
            <div class="boxes">
            </div>
        </div>
    </div>
    <br>
    <div class="generic-button black-button confirm-button" onclick="confirm()" id="confirm">تایید</div>
    <div class="generic-button black-button next-button" onclick="spin()" id="next">برنده بعدی</div>
    <div class="generic-button black-button end-button" onclick="end()" id="end">پایان قرعه‌کشی</div>
    <div class="generic-button ps5-button" onclick="ps5()" id="ps5">PS5</div>
    <div class="generic-button iphone-button" onclick="iphone()" id="iphone">آیفون</div>
</div>

<ul class="right">
    <li class="top">
        اسامی برندگان آیفون
    </li>
    <li>
        اسامی برندگان آیفون
    </li>
    <li>
        اسامی برندگان آیفون
    </li>
    <li>
        اسامی برندگان آیفون
    </li>
    <li>
        اسامی برندگان آیفون
    </li>
    <li>
        اسامی برندگان آیفون
    </li>

</ul>


<ul class="left">
    <li class="top">
        اسامی برندگان PS5
    </li>
    <li>
        اسامی برندگان آیفون
    </li>
    <li>
        اسامی برندگان آیفون
    </li>
    <li>
        اسامی برندگان آیفون
    </li>
    <li>
        اسامی برندگان آیفون
    </li>
    <li>
        اسامی برندگان آیفون
    </li>

</ul>


</body>
<script src="shuffled_indexed_records.js"></script>
<script>

    let fixedNumber = "572456";
    const persianNumbers = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];

    function toPersianNumeral(digit) {
        return persianNumbers[digit];
    }
    function toPersianNumberWholeNumber(number){
        return number
            .toString()
            .replace(/\d/g, x => persianNumbers[x]);
    }

    function hideDiv(divId) {
        document.getElementById(divId).style.display = 'none';
    }

    function showDiv(divId) {
        document.getElementById(divId).style.display = 'inline-flex'; // or 'inline', 'inline-block', etc., depending on your layout
    }

    //Input Code
    function convertInputToPersianNumerals(input) {
        console.log(input)
        input.innerHTML = input.innerHTML.replace(/\d/g, function (digit) {
            return persianNumbers[digit];
        });
    }

    function jumpToNext(element) {
        if (element.textContent.length === 1 && element.nextElementSibling && element.nextElementSibling.classList.contains('chance-number-input')) {
            element.nextElementSibling.focus();
        }
    }

    function convertPersianNumeralsToEnglish(persianNumerals) {
        const persianToEnglish = {
            '۰': '0', '۱': '1', '۲': '2', '۳': '3', '۴': '4',
            '۵': '5', '۶': '6', '۷': '7', '۸': '8', '۹': '9'
        };
        return persianNumerals.join('').split('').map(num => persianToEnglish[num] || num).join('');
    }

    function confirm() {
        let results = [];
        let chanceNumbers = document.querySelectorAll('.chance-number-input');
        chanceNumbers.forEach(function (div) {
            results.push(div.textContent);
        });
        fixedNumber = convertPersianNumeralsToEnglish(results);
        console.log("initial number is : " + fixedNumber);
        hideDiv('input');
        showDiv('winner');
        hideDiv('confirm');
        showDiv('iphone');
        showDiv('ps5');
        fillWinner(Number(fixedNumber));
    }

    window.onload = function () {
        document.querySelector('.first-number').focus();
    };

    //Winner Codes
    String.prototype.replaceAt = function(index, replacement) {
        return this.substring(0, index) + replacement + this.substring(index + replacement.length);
    }

    function fillWinner(winnerIndex) {
        let winner = data.records.filter(it => it.i === winnerIndex)[0];
        console.log(winner)
        let divs = document.querySelectorAll('.winner-phone');
        divs.forEach(function (div) {
            let toPersianNumberWholeNumber1 = toPersianNumberWholeNumber(winner.u)+"";
            console.log(toPersianNumberWholeNumber1)
            div.innerHTML = toPersianNumberWholeNumber1.replaceAt(4, "****");
        });
        divs = document.querySelectorAll('.winner-name');
        divs.forEach(function (div) {
            div.innerHTML = winner.n;
        });
        divs = document.querySelectorAll('.winner-chance');
        divs.forEach(function (div) {
            div.innerHTML = toPersianNumberWholeNumber(winner.p) + ' شانس';
        });
    }

    //Iphone PS5 codes
    let iphoneIndex = 0;
    let ps5Index = 0;

    //Spinner Codes
    const doors = document.querySelectorAll(".door");

    async function spin() {
        iteration = 0;
        init(false, 1, 2);
        for (const door of doors) {
            const boxes = door.querySelector(".boxes");
            const duration = parseInt(boxes.style.transitionDuration);
            boxes.style.transform = "translateY(0)";
            await new Promise((resolve) => setTimeout(resolve, duration * 100));
        }
    }


    function createOrderedArrayWithLastNumber(lastNumber) {
        let array = [];
        let firstnumber = (lastNumber + 1) % 10;
        for (let i = 0; i < 10; i++) {
            array.push(toPersianNumeral((i + firstnumber) % 10))
        }
        return array;
    }

    let iteration = 0;

    function init(firstInit = true, groups = 1, duration = 1) {
        for (const door of doors) {
            const boxes = door.querySelector(".boxes");
            const boxesClone = boxes.cloneNode(false);

            const pool = [""];
            if (!firstInit) {
                let numbers = createOrderedArrayWithLastNumber(Number(fixedNumber[iteration++]));
                pool.push(...numbers);

                boxesClone.addEventListener(
                    "transitionstart",
                    function () {
                        this.querySelectorAll(".box").forEach((box) => {
                            box.style.filter = "blur(1px)";
                        });
                    },
                    {once: true}
                );

                boxesClone.addEventListener(
                    "transitionend",
                    function () {
                        this.querySelectorAll(".box").forEach((box, index) => {
                            box.style.filter = "blur(0)";
                            if (index > 0) this.removeChild(box);
                        });
                    },
                    {once: true}
                );
            }

            for (let i = pool.length - 1; i >= 0; i--) {
                const box = document.createElement("div");
                box.classList.add("box");
                box.style.width = door.clientWidth + "px";
                box.style.height = door.clientHeight + "px";
                box.textContent = pool[i];
                boxesClone.appendChild(box);
            }
            boxesClone.style.transitionDuration = `${duration > 0 ? duration : 1}s`;
            boxesClone.style.transform = `translateY(-${
                door.clientHeight * (pool.length - 1)
            }px)`;
            door.replaceChild(boxesClone, boxes);
        }
    }

    function getRecordByIndex(index, callback) {
        fetch('shuffled_indexed_records.json')
            .then(response => response.json())
            .then(data => {
                const record = data.find(r => r.INDEX === index);
                if (record) {
                    callback(null, record);
                } else {
                    callback('Record not found', null);
                }
            })
            .catch(error => {
                callback(error, null);
            });
    }

    getRecordByIndex(5, (error, record) => {
        if (error) {
            console.error(error);
        } else {
            console.log('Record Information:', record);
        }
    });

    init();
</script>
</html>